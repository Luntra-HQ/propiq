<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PropIQ Stripe Checkout Test</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 { color: #333; margin-top: 0; }
    .test-section {
      margin: 20px 0;
      padding: 20px;
      background: #f9f9f9;
      border-left: 4px solid #8B5CF6;
      border-radius: 4px;
    }
    button {
      background: #8B5CF6;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      margin: 5px;
    }
    button:hover {
      background: #7C3AED;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .result {
      margin-top: 10px;
      padding: 15px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 14px;
      white-space: pre-wrap;
      word-break: break-all;
    }
    .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    .loading { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üß™ PropIQ Stripe Checkout Test</h1>
    <p><strong>Purpose:</strong> Debug the Stripe checkout flow to identify blockers before launch.</p>

    <!-- Test 1: Environment Check -->
    <div class="test-section">
      <h2>Test 1: Environment Verification</h2>
      <button onclick="testEnvironment()">Check Convex Configuration</button>
      <div id="env-result"></div>
    </div>

    <!-- Test 2: Stripe Price IDs -->
    <div class="test-section">
      <h2>Test 2: Stripe Price ID Validation</h2>
      <button onclick="validatePriceIds()">Validate Stripe Prices</button>
      <div id="price-result"></div>
    </div>

    <!-- Test 3: Checkout Session Creation -->
    <div class="test-section">
      <h2>Test 3: Create Test Checkout Session</h2>
      <p><strong>Note:</strong> This test requires you to be logged in. If you're not logged in, use the actual site first.</p>
      <button onclick="testCheckout('starter')">Test Starter ($49)</button>
      <button onclick="testCheckout('pro')">Test Pro ($99)</button>
      <button onclick="testCheckout('elite')">Test Elite ($199)</button>
      <div id="checkout-result"></div>
    </div>

    <!-- Test 4: Full Flow Simulation -->
    <div class="test-section">
      <h2>Test 4: Full Flow Simulation</h2>
      <ol>
        <li>Open <a href="https://propiq.luntra.one/pricing" target="_blank">PropIQ Pricing Page</a></li>
        <li>Open Browser DevTools (F12) ‚Üí Console tab</li>
        <li>Click "Choose Starter" button</li>
        <li>Watch for console logs starting with <code>[PRICING]</code></li>
        <li>Copy any error messages here:</li>
      </ol>
      <textarea id="manual-error" style="width: 100%; height: 100px; padding: 10px; font-family: monospace;"></textarea>
      <button onclick="analyzeError()">Analyze Error</button>
      <div id="analysis-result"></div>
    </div>
  </div>

  <script>
    // Convex configuration
    const CONVEX_URL = 'https://diligent-starling-125.convex.cloud';

    // Price IDs from config
    const PRICE_IDS = {
      starter: 'price_1SXQEsJogOchEFxvG8fT5B0b',
      pro: 'price_1SL51sJogOchEFxvVounuNcK',
      elite: 'price_1SXQF2JogOchEFxvRpZ0GGuf'
    };

    function showResult(elementId, message, type = 'info') {
      const element = document.getElementById(elementId);
      element.innerHTML = `<div class="result ${type}">${message}</div>`;
    }

    function showLoading(elementId) {
      showResult(elementId, '‚è≥ Loading...', 'loading');
    }

    // Test 1: Environment Check
    function testEnvironment() {
      showLoading('env-result');

      const results = [];
      results.push('=== Environment Check ===\n');
      results.push(`‚úÖ Convex URL: ${CONVEX_URL}`);
      results.push(`‚úÖ Price IDs configured: ${Object.keys(PRICE_IDS).length}`);
      results.push(`\nPrice IDs:`);
      Object.entries(PRICE_IDS).forEach(([tier, priceId]) => {
        results.push(`  ‚Ä¢ ${tier}: ${priceId}`);
      });

      // Check browser compatibility
      results.push(`\n=== Browser Info ===`);
      results.push(`Browser: ${navigator.userAgent}`);
      results.push(`Cookies enabled: ${navigator.cookieEnabled}`);
      results.push(`LocalStorage available: ${typeof localStorage !== 'undefined'}`);

      showResult('env-result', results.join('\n'), 'success');
    }

    // Test 2: Validate Price IDs
    async function validatePriceIds() {
      showLoading('price-result');

      const results = [];
      results.push('=== Stripe Price ID Validation ===\n');
      results.push('Note: This test only checks format, not if prices exist in Stripe.\n');

      Object.entries(PRICE_IDS).forEach(([tier, priceId]) => {
        const isValid = /^price_[a-zA-Z0-9]+$/.test(priceId);
        const status = isValid ? '‚úÖ' : '‚ùå';
        results.push(`${status} ${tier}: ${priceId}`);
      });

      results.push('\nüí° To verify these prices exist in Stripe:');
      results.push('   Run: stripe prices list --limit 10');

      showResult('price-result', results.join('\n'), 'info');
    }

    // Test 3: Create Checkout Session
    async function testCheckout(tier) {
      showLoading('checkout-result');

      const results = [];
      results.push(`=== Testing ${tier.toUpperCase()} Checkout ===\n`);

      try {
        // Check if user is logged in
        const user = null; // TODO: Get from Convex auth

        if (!user) {
          results.push('‚ùå Not logged in');
          results.push('\nTo test checkout:');
          results.push('1. Go to https://propiq.luntra.one');
          results.push('2. Sign up or log in');
          results.push('3. Return to this page');
          results.push('4. Click the test button again');
          showResult('checkout-result', results.join('\n'), 'error');
          return;
        }

        // Simulate checkout creation
        results.push('‚è≥ Creating checkout session...');
        results.push(`Tier: ${tier}`);
        results.push(`Price ID: ${PRICE_IDS[tier]}`);
        results.push(`Convex URL: ${CONVEX_URL}`);

        // In real implementation, this would call Convex action
        // For now, show what WOULD happen
        results.push('\n‚úÖ Expected flow:');
        results.push('1. Call api.payments.createCheckoutSession');
        results.push('2. Convex fetches Stripe API');
        results.push('3. Returns checkout session URL');
        results.push('4. Browser redirects to Stripe');

        showResult('checkout-result', results.join('\n'), 'info');

      } catch (error) {
        results.push(`\n‚ùå Error: ${error.message}`);
        showResult('checkout-result', results.join('\n'), 'error');
      }
    }

    // Test 4: Analyze Manual Error
    function analyzeError() {
      const errorText = document.getElementById('manual-error').value.trim();

      if (!errorText) {
        showResult('analysis-result', '‚ö†Ô∏è Please paste an error message first', 'error');
        return;
      }

      const results = [];
      results.push('=== Error Analysis ===\n');

      // Common error patterns
      if (errorText.includes('User not found')) {
        results.push('‚ùå Problem: User not found');
        results.push('\nüîß Solution:');
        results.push('   ‚Ä¢ Make sure you\'re logged in');
        results.push('   ‚Ä¢ Check Convex auth configuration');
        results.push('   ‚Ä¢ Verify user exists in Convex database');
      }
      else if (errorText.includes('Stripe not configured')) {
        results.push('‚ùå Problem: Stripe environment variables missing');
        results.push('\nüîß Solution:');
        results.push('   Run these commands:');
        results.push('   npx convex env set STRIPE_SECRET_KEY "sk_live_..."');
        results.push('   npx convex env set STRIPE_STARTER_PRICE_ID "price_..."');
      }
      else if (errorText.includes('Invalid subscription tier')) {
        results.push('‚ùå Problem: Price ID not found');
        results.push('\nüîß Solution:');
        results.push('   ‚Ä¢ Verify price IDs exist in Stripe dashboard');
        results.push('   ‚Ä¢ Make sure you\'re in LIVE mode (not test mode)');
      }
      else if (errorText.includes('Failed to fetch')) {
        results.push('‚ùå Problem: Network or CORS error');
        results.push('\nüîß Solution:');
        results.push('   ‚Ä¢ Check internet connection');
        results.push('   ‚Ä¢ Verify Convex deployment is running');
        results.push('   ‚Ä¢ Check browser console for CORS errors');
      }
      else {
        results.push('‚ö†Ô∏è Unknown error pattern');
        results.push('\nError message:');
        results.push(errorText);
        results.push('\nüí° Next steps:');
        results.push('   ‚Ä¢ Check Convex logs: https://dashboard.convex.dev');
        results.push('   ‚Ä¢ Check Stripe logs: https://dashboard.stripe.com/logs');
      }

      showResult('analysis-result', results.join('\n'), 'info');
    }
  </script>
</body>
</html>
